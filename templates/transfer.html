{% extends "base.html" %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-md-5">
    <h3>Para Gönder</h3>
    <p>Mevcut bakiye: {{ "%.2f"|format(current_user.balance) }} SRDS</p>
    <form method="post" novalidate>
      {{ form.hidden_tag() }}

      <div class="mb-3">
        {{ form.to_email.label(class="form-label") }}
        <div class="input-group">
          {{ form.to_email(class="form-control", id="to_email") }}
          <button type="button" class="btn btn-outline-secondary" id="scanBtn">QR</button>
        </div>
      </div>

      <div class="mb-3">
        {{ form.amount.label(class="form-label") }}
        {{ form.amount(class="form-control") }}
      </div>

      <div class="mb-3">
        {{ form.message.label(class="form-label") }}
        {{ form.message(class="form-control", rows="3", placeholder="Alıcıya mesaj (opsiyonel)") }}
      </div>

      {{ form.submit(class="btn btn-primary") }}
    </form>
  </div>
</div>

<!-- QR Modal -->
<div class="modal fade" id="qrModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">QR Tara</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <div class="modal-body">
        <div id="qr-reader" style="width:100%;"></div>
        <small class="text-muted">Kameraya erişime izin verin.</small>
      </div>
    </div>
  </div>
</div>

<script>
  let html5Qrcode = null;
  let scanning = false;

  const modalEl = document.getElementById('qrModal');
  const toEmail = document.getElementById('to_email');

  document.getElementById('scanBtn').addEventListener('click', () => {
    const m = new bootstrap.Modal(modalEl);
    m.show();
    startScanner();
  });

  modalEl.addEventListener('hidden.bs.modal', stopScanner);

  function startScanner() {
    if (!html5Qrcode) html5Qrcode = new Html5Qrcode("qr-reader");
    Html5Qrcode.getCameras().then(cams => {
      if (!cams || cams.length === 0) return;
      const camId = cams[0].id;
      html5Qrcode.start(
        camId,
        { fps: 10, qrbox: { width: 250, height: 250 } },
        (decodedText) => {
          toEmail.value = decodedText.trim();
          stopScanner();
          const inst = bootstrap.Modal.getInstance(modalEl);
          if (inst) inst.hide();
        },
        () => {}
      ).then(() => { scanning = true; });
    }).catch(() => {});
  }

  function stopScanner() {
    if (html5Qrcode && scanning) {
      html5Qrcode.stop().then(() => {
        html5Qrcode.clear();
        scanning = false;
      });
    }
  }
</script>
{% endblock %}
