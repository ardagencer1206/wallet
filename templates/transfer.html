{% extends "base.html" %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-md-5">
    <h3>Para Gönder</h3>
    <p>Mevcut bakiye: {{ "%.2f"|format(current_user.balance) }} SRDS</p>
    <form method="post" novalidate>
      {{ form.hidden_tag() }}

      <div class="mb-3">
        {{ form.to_email.label(class="form-label") }}
        <div class="input-group">
          {{ form.to_email(class="form-control", id="to_email") }}
          <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#qrModal" aria-label="QR Oku">QR</button>
        </div>
      </div>

      <div class="mb-3">
        {{ form.amount.label(class="form-label") }}
        {{ form.amount(class="form-control") }}
      </div>

      <div class="mb-3">
        {{ form.message.label(class="form-label") }}
        {{ form.message(class="form-control", rows="3", placeholder="Alıcıya mesaj (opsiyonel)") }}
      </div>

      {{ form.submit(class="btn btn-primary") }}
    </form>
  </div>
</div>

<!-- QR Modal -->
<div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="qrModalLabel">QR Kodunu Tara</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <div class="modal-body">
        <div id="qr-reader" style="width:100%"></div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  let html5QrCode = null;

  const parseEmail = (text) => {
    // mailto:foo@bar.com veya düz e-posta destekle
    let t = (text || "").trim();
    if (t.toLowerCase().startsWith("mailto:")) t = t.slice(7);
    // basit doğrulama
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(t) ? t : null;
  };

  const startScanner = () => {
    const el = document.getElementById('qr-reader');
    html5QrCode = new Html5Qrcode(/* element id or element */ "qr-reader");
    const config = { fps: 10, qrbox: 250, experimentalFeatures: { useBarCodeDetectorIfSupported: true } };
    const constraints = { facingMode: { ideal: "environment" } }; // mobil arka kamera

    html5QrCode.start(constraints, config, (decodedText) => {
      const email = parseEmail(decodedText);
      if (email) {
        document.getElementById('to_email').value = email;
        stopScanner();
        // modal kapat
        const modalEl = document.getElementById('qrModal');
        const modal = bootstrap.Modal.getInstance(modalEl);
        modal && modal.hide();
      }
    }).catch(() => {
      // kamera başlatılamazsa sessiz geç.
    });
  };

  const stopScanner = () => {
    if (html5QrCode) {
      html5QrCode.stop().then(() => {
        html5QrCode.clear();
        html5QrCode = null;
      }).catch(() => {});
    }
  };

  // Modal açılınca başlat, kapanınca durdur
  const modalEl = document.getElementById('qrModal');
  modalEl.addEventListener('shown.bs.modal', startScanner);
  modalEl.addEventListener('hide.bs.modal', stopScanner);
})();
</script>
{% endblock %}
