{% extends "base.html" %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-md-5">
    <h3>Para Gönder</h3>
    <p>Mevcut bakiye: {{ "%.2f"|format(current_user.balance) }} SRDS</p>
    <form method="post" novalidate>
      {{ form.hidden_tag() }}

      <div class="mb-3">
        {{ form.to_email.label(class="form-label") }}
        <div class="input-group">
          {{ form.to_email(class="form-control", id="to_email") }}
          <button type="button" class="btn btn-outline-secondary" id="scanBtn">QR</button>
        </div>
      </div>

      <div class="mb-3">
        {{ form.amount.label(class="form-label") }}
        {{ form.amount(class="form-control") }}
      </div>

      <div class="mb-3">
        {{ form.message.label(class="form-label") }}
        {{ form.message(class="form-control", rows="3", placeholder="Alıcıya mesaj (opsiyonel)") }}
      </div>

      {{ form.submit(class="btn btn-primary") }}
    </form>
  </div>
</div>

<!-- QR Modal -->
<div class="modal fade" id="qrModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">QR Tara</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <div class="modal-body">
        <div id="qr-reader" style="width:100%;"></div>
        <small class="text-muted">Kameraya erişime izin verin.</small>
      </div>
    </div>
  </div>
</div>

<script>
  let html5Qrcode = null;
  let scanning = false;

  const modalEl = document.getElementById('qrModal');
  const toEmail = document.getElementById('to_email');
  const scanBtn = document.getElementById('scanBtn');

  scanBtn.addEventListener('click', () => {
    const m = new bootstrap.Modal(modalEl);
    m.show();
  });

  // Modal açıldığında başlat, kapandığında durdur
  modalEl.addEventListener('shown.bs.modal', () => startScanner());
  modalEl.addEventListener('hidden.bs.modal', () => stopScanner());

  function pickBackCamera(cams) {
    // label'da arka kamerayı arar; yoksa son cihazı seçer
    const byLabel = cams.find(c => /back|rear|environment|arka|dış/i.test(c.label || ""));
    if (byLabel) return byLabel.id;
    return (cams[cams.length - 1] || cams[0]).id;
  }

  async function startScanner() {
    if (!window.Html5Qrcode) return;
    if (!html5Qrcode) html5Qrcode = new Html5Qrcode("qr-reader");
    if (scanning) return;

    const opts = { fps: 10, qrbox: { width: 250, height: 250 } };
    const onSuccess = (decodedText) => {
      toEmail.value = decodedText.trim();
      stopScanner().finally(() => {
        const inst = bootstrap.Modal.getInstance(modalEl);
        if (inst) inst.hide();
      });
    };

    try {
      // 1) Tüm tarayıcılarda arka kamerayı tercih etmek için facingMode dene
      await html5Qrcode.start({ facingMode: { exact: "environment" } }, opts, onSuccess);
      scanning = true;
      return;
    } catch (_) {
      // facingMode desteklenmiyorsa fallback yap
    }

    try {
      // 2) Cihaz listesinden seç
      const cams = await Html5Qrcode.getCameras();
      if (!cams || cams.length === 0) throw new Error("No camera");
      const camId = pickBackCamera(cams);
      await html5Qrcode.start(camId, opts, onSuccess);
      scanning = true;
    } catch (e) {
      // 3) Son çare: herhangi bir constraint ile dene (ön/arka fark etmez)
      try {
        await html5Qrcode.start({ facingMode: "user" }, opts, onSuccess);
        scanning = true;
      } catch (err) {
        console.error("QR başlatılamadı:", err);
      }
    }
  }

  async function stopScanner() {
    if (html5Qrcode && scanning) {
      try { await html5Qrcode.stop(); } catch (_) {}
      html5Qrcode.clear();
      scanning = false;
    }
  }
</script>
{% endblock %}
