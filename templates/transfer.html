{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">
        <h3>Para Gönder</h3>
        <p class="text-muted">Mevcut bakiye: <strong>{{ "%.2f"|format(current_user.balance) }} SRDS</strong></p>
        
        <form method="post" novalidate>
            {{ form.hidden_tag() }}
            
            <div class="mb-3">
                {{ form.to_email.label(class="form-label") }}
                <div class="input-group">
                    {{ form.to_email(class="form-control", id="toEmail", placeholder="Alıcının e-posta adresi") }}
                    <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#qrModal">
                        <i class="bi bi-qr-code-scan"></i> QR ile Oku
                    </button>
                </div>
            </div>
            
            <div class="mb-3">
                {{ form.amount.label(class="form-label") }}
                {{ form.amount(class="form-control", placeholder="Örn: 15.50") }}
            </div>
            
            <div class="mb-3">
                {{ form.message.label(class="form-label") }}
                {{ form.message(class="form-control", rows="3", placeholder="Alıcıya bir not gönderin (isteğe bağlı)") }}
            </div>
            
            {{ form.submit(class="btn btn-primary w-100") }}
        </form>
    </div>
</div>

<div class="modal fade" id="qrModal" tabindex="-1" aria-labelledby="qrModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="qrModalLabel">QR Kodu Tara</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            <div class="modal-body text-center p-0">
                <video id="qrVideo" autoplay playsinline style="width:100%; height:auto; display:block;"></video>
                <canvas id="qrCanvas" style="display:none;"></canvas>
                <div class="p-3">
                    <div class="small text-muted mt-2">Kamerayı e-posta adresini içeren QR koda yöneltin.</div>
                    <div id="qrError" class="text-danger small mt-2" style="display:none;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Vazgeç</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

<script>
// Kodun diğer scriptlerle çakışmasını önlemek için bir IIFE (Immediately Invoked Function Expression) içine alıyoruz.
(function() {
    'use strict'; // Hataları daha erken fark etmek için katı modu etkinleştirir.

    // Gerekli DOM elementlerini seçiyoruz
    const modalEl = document.getElementById('qrModal');
    if (!modalEl) return; // Modal yoksa scripti çalıştırma

    const video = document.getElementById('qrVideo');
    const canvas = document.getElementById('qrCanvas');
    const ctx = canvas.getContext('2d');
    const toEmailInput = document.getElementById('toEmail');
    const errorBox = document.getElementById('qrError');

    // Bootstrap Modal nesnesini başlangıçta oluşturuyoruz
    const bsModal = new bootstrap.Modal(modalEl);

    let stream = null;
    let animationFrameId = null;

    // Kamera akışını ve tarama döngüsünü durduran fonksiyon
    function stopScan() {
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
        }
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
    }

    // QR kodu taramak için sürekli çalışan döngü
    function scanLoop() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.height = video.videoHeight;
            canvas.width = video.videoWidth;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
                inversionAttempts: "dontInvert",
            });

            // QR kod bulunursa...
            if (code && code.data) {
                const qrData = code.data.trim();
                toEmailInput.value = qrData; // Veriyi input alanına yaz
                bsModal.hide(); // Modalı otomatik kapat
                return; // Döngüyü sonlandır
            }
        }
        // Kod bulunamazsa bir sonraki frame'de tekrar dene
        animationFrameId = requestAnimationFrame(scanLoop);
    }

    // Modal penceresi açıldığında çalışacak olay dinleyicisi
    modalEl.addEventListener('shown.bs.modal', async () => {
        errorBox.style.display = 'none';
        try {
            // Kullanıcıdan kamera izni iste (tercihen arka kamera)
            stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: { ideal: "environment" } },
                audio: false
            });
            
            video.srcObject = stream;
            video.play(); // Kamerayı oynat
            
            // Tarama döngüsünü başlat
            animationFrameId = requestAnimationFrame(scanLoop);

        } catch (err) {
            console.error("Kamera Hatası:", err);
            errorBox.textContent = "Kamera erişimi reddedildi veya bir hata oluştu. Lütfen sayfa izinlerini kontrol edin.";
            errorBox.style.display = 'block';
        }
    });

    // Modal penceresi kapandığında kamerayı serbest bırak
    modalEl.addEventListener('hidden.bs.modal', () => {
        stopScan();
    });

})();
</script>
{% endblock %}
