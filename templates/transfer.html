{% extends "base.html" %}
{% block content %}

<style>
  /* Glassmorphism */
  .glass {
    background: rgba(255, 255, 255, 0.12);
    border: 1px solid rgba(255, 255, 255, 0.25);
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.18);
    border-radius: 1rem;
  }
  .auth-bg {
    background: radial-gradient(1200px 1200px at 10% -10%, #7c4dff33, transparent 60%),
                radial-gradient(1000px 800px at 110% 10%, #00e5ff33, transparent 55%),
                linear-gradient(135deg, #0f172a, #111827 60%, #0b1020);
  }
  .form-control {
    background-color: rgba(255,255,255,0.08);
    border-color: rgba(255,255,255,0.25);
    color: #e5e7eb;
  }
  .form-control:focus {
    background-color: rgba(255,255,255,0.12);
    border-color: #8b5cf6;
    color: #fff;
    box-shadow: 0 0 0 .25rem rgba(139,92,246,.25);
  }
  label { color: #cbd5e1; }
  .btn-gradient {
    background: linear-gradient(135deg, #8b5cf6, #06b6d4);
    border: 0; color: #0b1020; font-weight: 600;
  }
  .btn-gradient:hover { opacity: .95; }
  .stat-pill {
    display: inline-flex; align-items: center; gap:.5rem;
    padding:.5rem .75rem; border-radius: 999px;
    background: rgba(255,255,255,.08); color:#e5e7eb; font-size:.9rem;
    border:1px solid rgba(255,255,255,.2);
  }
</style>

<div class="auth-bg min-vh-100 d-flex align-items-center py-5">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-sm-11 col-md-9 col-lg-6">
        <div class="glass p-4 p-md-5">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="text-white m-0">Para Gönder</h3>
            <span class="stat-pill">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-wallet2" viewBox="0 0 16 16"><path d="M12.136.326A1.5 1.5 0 0 1 14 1.789V3h.5A1.5 1.5 0 0 1 16 4.5v8A1.5 1.5 0 0 1 14.5 14H2A2 2 0 0 1 0 12V4a2 2 0 0 1 2-2h8.5a1.5 1.5 0 0 1 1.636-1.674ZM2 3a1 1 0 0 0-1 1v8c0 .552.448 1 1 1h12.5a.5.5 0 0 0 .5-.5v-8A.5.5 0 0 0 14.5 4H2Z"/></svg>
              Bakiye: {{ "%.2f"|format(current_user.balance) }} SRDS
            </span>
          </div>

          <form method="post" novalidate class="mt-3">
            {{ form.hidden_tag() }}

            <div class="mb-3">
              {{ form.to_email.label(class="form-label") }}
              <div class="input-group">
                {{ form.to_email(class="form-control", id="to_email", placeholder="alici@eposta.com") }}
                <button type="button" class="btn btn-outline-secondary" id="scanBtn" title="QR Tara">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-qr-code-scan" viewBox="0 0 16 16"><path d="M2 2h2v2H2V2Zm0 3h1v1H2V5Zm2 0h1v1H4V5Zm1-3h1v1H5V2Zm3 0h1v1H8V2Zm1 3h1v1H9V5Zm-1 0h1v1H8V5ZM7 2h1v1H7V2ZM2 8h1v1H2V8Zm3 0h1v1H5V8Zm-3 3h2v2H2v-2Zm3 2v-1h1v1H5Zm3 0v-1h1v1H8Zm6-11h-2v2h2V2Zm-3 0h-1v1h1V2Zm3 3h-1v1h1V5Zm-3 0h-1v1h1V5ZM2 12h1v1H2v-1Zm9-4h1v1h-1V8Zm1 2h1v1h-1v-1Zm-1 1h1v1h-1v-1Zm2 1h1v1h-1v-1Zm-4-4h1v1h-1V8Zm-1 3h1v1h-1v-1Z"/></svg>
                </button>
              </div>
            </div>

            <div class="mb-3">
              {{ form.amount.label(class="form-label") }}
              {{ form.amount(class="form-control", placeholder="0.00") }}
            </div>

            <div class="mb-3">
              {{ form.message.label(class="form-label") }}
              {{ form.message(class="form-control", rows="3", placeholder="Alıcıya mesaj (opsiyonel)") }}
            </div>

            <div class="d-grid">
              {{ form.submit(class="btn btn-gradient btn-lg") }}
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- QR Modal -->
<div class="modal fade" id="qrModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content glass">
      <div class="modal-header">
        <h5 class="modal-title text-white">QR Tara</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <div class="modal-body">
        <div id="qr-reader" style="width:100%; min-height:260px;"></div>
        <small class="text-muted">Kameraya erişime izin verin.</small>
      </div>
    </div>
  </div>
</div>

<script>
  let html5Qrcode = null;
  let scanning = false;

  const modalEl = document.getElementById('qrModal');
  const toEmail = document.getElementById('to_email');
  const scanBtn = document.getElementById('scanBtn');

  scanBtn.addEventListener('click', () => {
    const m = new bootstrap.Modal(modalEl);
    m.show();
  });

  // Modal açıldığında başlat, kapandığında durdur
  modalEl.addEventListener('shown.bs.modal', () => startScanner());
  modalEl.addEventListener('hidden.bs.modal', () => stopScanner());

  function pickBackCamera(cams) {
    // label'da arka kamerayı arar; yoksa son cihazı seçer
    const byLabel = cams.find(c => /back|rear|environment|arka|dış/i.test(c.label || ""));
    if (byLabel) return byLabel.id;
    return (cams[cams.length - 1] || cams[0]).id;
  }

  async function startScanner() {
    if (!window.Html5Qrcode) return;
    if (!html5Qrcode) html5Qrcode = new Html5Qrcode("qr-reader");
    if (scanning) return;

    const opts = { fps: 10, qrbox: { width: 250, height: 250 } };
    const onSuccess = (decodedText) => {
      toEmail.value = decodedText.trim();
      stopScanner().finally(() => {
        const inst = bootstrap.Modal.getInstance(modalEl);
        if (inst) inst.hide();
      });
    };

    try {
      // 1) Arka kamerayı facingMode ile zorla
      await html5Qrcode.start({ facingMode: { exact: "environment" } }, opts, onSuccess);
      scanning = true;
      return;
    } catch (_) {
      // facingMode desteklenmiyorsa devam et
    }

    try {
      // 2) Cihaz listesinden en mantıklı kamerayı seç
      const cams = await Html5Qrcode.getCameras();
      if (!cams || cams.length === 0) throw new Error("No camera");
      const camId = pickBackCamera(cams);
      await html5Qrcode.start(camId, opts, onSuccess);
      scanning = true;
    } catch (e) {
      // 3) Son çare: ön kamera da olur
      try {
        await html5Qrcode.start({ facingMode: "user" }, opts, onSuccess);
        scanning = true;
      } catch (err) {
        console.error("QR başlatılamadı:", err);
      }
    }
  }

  async function stopScanner() {
    if (html5Qrcode && scanning) {
      try { await html5Qrcode.stop(); } catch (_) {}
      html5Qrcode.clear();
      scanning = false;
    }
  }
</script>
{% endblock %}
