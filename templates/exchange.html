{% extends "base.html" %}
{% block title %}Exchange{% endblock %}
{% block content %}

<style>
  .glass{background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25);
         backdrop-filter:blur(14px);-webkit-backdrop-filter:blur(14px);
         box-shadow:0 10px 30px rgba(0,0,0,.18);border-radius:1rem}
  .card-grad{background:linear-gradient(135deg, rgba(139,92,246,.18), rgba(6,182,212,.18))}
  .metric{font-variant-numeric:tabular-nums}
  .muted{color:#cbd5e1}
  .hint{font-size:.85rem}
  .tile{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);border-radius:1rem;padding:1rem}
  .btn-gradient{background:linear-gradient(135deg,#8b5cf6,#06b6d4);border:0;color:#0b1020;font-weight:600}
</style>

<div class="container py-2">
  <div class="d-flex align-items-end justify-content-between mb-3">
    <div>
      <h2 class="mb-0">Exchange</h2>
      <div class="muted">TRY ⇄ SRDS dönüşümü</div>
    </div>
    <div class="tile d-flex align-items-center gap-2">
      <small class="muted">SRDS Value</small>
      <span class="metric">{{ ('%.8f' % (srds_value or 0)) if srds_value is not none else '0.00000000' }}</span>
      <small class="muted">TRY / SRDS</small>
    </div>
  </div>

  {% if current_user.is_authenticated %}
  <!-- Balances -->
  <div class="row g-3 mb-3">
    <div class="col-md-6">
      <div class="glass card-grad p-3">
        <div class="d-flex justify-content-between">
          <div>
            <div class="muted">SRDS Bakiyesi</div>
            <div class="h3 metric mb-0">{{ "%.2f"|format(current_user.balance or 0) }} SRDS</div>
          </div>
          <div class="text-end">
            <div class="muted">TRY Bakiyesi</div>
            <div class="h3 metric mb-0">{{ "%.2f"|format(current_user.try_balance or 0) }} TRY</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <div class="row g-3">
    <!-- BUY SRDS WITH TRY -->
    <div class="col-md-6">
      <div class="glass p-4 h-100">
        <h5 class="mb-3">SRDS Al (TRY kullan)</h5>
        <form method="post" novalidate>
          {{ form.hidden_tag() if form and form.hidden_tag }}
          <div class="mb-3">
            <label class="form-label">TRY Tutarı</label>
            {% if form and form.amount_try %}
              {{ form.amount_try(class="form-control", id="buy_try", placeholder="Örn: 100.00") }}
            {% else %}
              <input type="number" step="0.01" name="amount_try" id="buy_try" class="form-control" placeholder="Örn: 100.00">
            {% endif %}
            <div class="form-text hint">Girilen tutar kasaya (id=11) TRY olarak aktarılır.</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Tahmini SRDS</label>
            <input type="text" id="buy_srds_est" class="form-control" readonly>
            <div class="form-text hint">Tahmin ücrete dahil değildir. %0.2 komisyon SRDS olarak kesilir.</div>
          </div>
          {% if form and form.submit_buy %}
            {{ form.submit_buy(class="btn btn-gradient w-100") }}
          {% else %}
            <button type="submit" name="submit_buy" class="btn btn-gradient w-100">Satın Al</button>
          {% endif %}
        </form>
      </div>
    </div>

    <!-- SELL SRDS FOR TRY -->
    <div class="col-md-6">
      <div class="glass p-4 h-100">
        <h5 class="mb-3">SRDS Sat (TRY al)</h5>
        <form method="post" novalidate>
          {{ form.hidden_tag() if form and form.hidden_tag }}
          <div class="mb-3">
            <label class="form-label">SRDS Tutarı</label>
            {% if form and form.amount_srds %}
              {{ form.amount_srds(class="form-control", id="sell_srds", placeholder="Örn: 50.00") }}
            {% else %}
              <input type="number" step="0.01" name="amount_srds" id="sell_srds" class="form-control" placeholder="Örn: 50.00">
            {% endif %}
            <div class="form-text hint">Satılan SRDS doğrudan komisyon havuzuna gider. Dolaşım azalır.</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Tahmini TRY</label>
            <input type="text" id="sell_try_est" class="form-control" readonly>
            <div class="form-text hint">Tahmin ücrete dahil değildir. %0.2 komisyon SRDS olarak kesilir.</div>
          </div>
          {% if form and form.submit_sell %}
            {{ form.submit_sell(class="btn btn-outline-light w-100") }}
          {% else %}
            <button type="submit" name="submit_sell" class="btn btn-outline-light w-100">Sat</button>
          {% endif %}
        </form>
      </div>
    </div>
  </div>

</div>

<script>
  // SRDS value from context
  const SRDS_VALUE = {{ (srds_value or 0)|float }};
  const FEE_RATE = 0.002; // %0.2

  // Elements
  const buyTry      = document.getElementById('buy_try');
  const buySrdsEst  = document.getElementById('buy_srds_est');
  const sellSrds    = document.getElementById('sell_srds');
  const sellTryEst  = document.getElementById('sell_try_est');

  function fmt(n, d=2){ if(isNaN(n)) return ''; return Number(n).toFixed(d); }

  // BUY: TRY -> SRDS estimate (without fee)
  function updateBuyEst(){
    if(!buyTry || !buySrdsEst) return;
    const t = parseFloat(buyTry.value);
    if(!t || t<=0 || !SRDS_VALUE){ buySrdsEst.value=''; return; }
    const srds = t / SRDS_VALUE;
    buySrdsEst.value = fmt(srds, 6);
  }

  // SELL: SRDS -> TRY estimate (without fee)
  function updateSellEst(){
    if(!sellSrds || !sellTryEst) return;
    const s = parseFloat(sellSrds.value);
    if(!s || s<=0 || !SRDS_VALUE){ sellTryEst.value=''; return; }
    const tryAmt = s * SRDS_VALUE;
    sellTryEst.value = fmt(tryAmt, 2);
  }

  if(buyTry)   buyTry.addEventListener('input', updateBuyEst);
  if(sellSrds) sellSrds.addEventListener('input', updateSellEst);

  updateBuyEst();
  updateSellEst();
</script>

{% endblock %}
